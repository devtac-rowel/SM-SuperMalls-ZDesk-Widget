<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <title>Zoho Desk - Apps</title>
</head>

<body>
<h2>This is a samplesdsdd App built using ZET CLI.</h2>

<script src="https://js.zohostatic.com/support/developer_sdk/v1/js/ZohoDeskClientSDK.min.js"></script>
<script>
    const orgID = "847734955";

    async function processChangeTicketStatus() {
        try {
            const response = await ZOHODESK.get("ticket");
            if (!response || response.status !== "success" || !response.ticket) {
                return;
            }

            const ticket = response.ticket;
            if (ticket.status !== "Open") {
                return;
            }

            const userResponse = await ZOHODESK.get("user");
            const userID = userResponse.user.id;

            if (ticket.assignee.id === userID) {
                const requestParams = {
                    url: "https://desk.zoho.com/api/v1/tickets",
                    type: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        orgId: orgID,
                    },
                    postBody: {},
                    data: {
                        assignee: userID,
                        status: "In Progress",
                        departmentId: ticket.departmentId,
                    },
                    connectionLinkName: "sm_zoho_desk_conn",
                };

                const res = await ZOHODESK.request(requestParams);
                let jsonResponse = JSON.parse(res).response;
                let responseData = JSON.parse(jsonResponse).statusMessage.data;

                if (responseData && responseData.length) {
                    let currentInProgressTicket = responseData.shift();
                    alertMessage({
                        title: `Status Notification: Ticket #${ticket.number}`,
                        content: `Current ticket status cannot be changed. Ticket #${currentInProgressTicket.ticketNumber} is currently In Progress`,
                        icon: "failure",
                    });
                } else {
                    const resp = await ZOHODESK.request({
                        url: `https://support.zoho.com/api/v1/tickets/${ticket.id}/blueprint`,
                        type: "GET",
                        headers: {
                            "Content-Type": "application/json",
                            orgId: orgID,
                        },
                        postBody: {},
                        data: {},
                        connectionLinkName: "sm_zoho_desk_conn",
                    });

                    let varResp = JSON.parse(resp).response;
                    let blueprintID = JSON.parse(varResp).statusMessage.id;
                    if (blueprintID) {
                        await updateStatusViaBlueprintTransition(blueprintID, ticket);
                    } else {
                        await updateStatusViaAPI(ticket);
                    }
                }
            }
        } catch (error) {
            console.log(error);
            // alertMessage({
            //     title: `Error!`,
            //     content: `Please Contact the Administration`,
            //     icon: "failure",
            // });
        }
    }

    async function updateStatusViaBlueprintTransition(blueprintID, ticket) {
        try {
            const blueprintRes = await ZOHODESK.request({
                url: `https://support.zoho.com/api/v1/blueprints/${blueprintID}`,
                type: "GET",
                headers: {
                    "Content-Type": "application/json",
                    orgId: orgID,
                },
                postBody: {},
                data: {},
                connectionLinkName: "sm_zoho_desk_conn",
            });

            let blueprintTransitions = JSON.parse(blueprintRes).response;
            blueprintTransitions = JSON.parse(blueprintTransitions).statusMessage.transitions;

            let transitionID;
            Object.values(blueprintTransitions).forEach(function (data) {
                if (data.name === "In Progress") {
                    transitionID = data.id;
                    return;
                }
            });

            const transitionParams = {
                url: `https://support.zoho.com/api/v1/tickets/${ticket.id}/transitions/${transitionID}/perform`,
                type: "POST",
                headers: {
                    "Content-Type": "application/json",
                    orgId: orgID,
                },
                postBody: {"FIELD_UPDATE": {"channel": ""}},
                data: {},
                connectionLinkName: "sm_zoho_desk_conn",
            };

            await ZOHODESK.request(transitionParams);
            alertMessage({
                title: `Status Notification: Ticket #${ticket.number}`,
                content: "Status was changed to In Progress.",
                icon: "success",
            });
        } catch (error) {
            console.log(error);
            alertMessage({
                title: `Error!`,
                content: `Please Contact the Administration`,
                icon: "failure",
            });
        }
    }

    async function updateStatusViaAPI(ticket) {
        try {
            const params = {
                url: `https://support.zoho.com/api/v1/tickets/${ticket.id}`,
                type: "PATCH",
                headers: {
                    "Content-Type": "application/json",
                    orgId: orgID,
                },
                postBody: {
                    "status": "In Progress"
                },
                data: {},
                connectionLinkName: "sm_zoho_desk_conn",
            };

            await ZOHODESK.request(params);
            alertMessage({
                title: `Status Notification: Ticket #${ticket.number}`,
                content: "Status was changed to In Progress.",
                icon: "success",
            });
        } catch (error) {
            console.log(error);
            alertMessage({
                title: `Error!`,
                content: `Please Contact the Administration`,
                icon: "failure",
            });
        }
    }

    function alertMessage(data) {
        const alertParams = {
            title: data.title,
            content: data.content,
            icon: data.icon,
            autoClose: true,
        };

        ZOHODESK.notify(alertParams);
    }

    window.onload = async () => {
        try {
            const App = await ZOHODESK.extension.onload();
            processChangeTicketStatus();

            App.instance.on("ticket_Shift", function (data) {
                if (!data) {
                    console.log("Something Went Wrong in Ticket Shift Function");
                    return;
                }

                processChangeTicketStatus();
            });
        } catch (error) {
            console.log(error);
            alertMessage({
                title: `Error!`,
                content: `Please Contact the Administration`,
                icon: "failure",
            });
        }
    };

</script>

<script src="./js/extension.js" charset="utf-8"></script>
</body>
</html>
