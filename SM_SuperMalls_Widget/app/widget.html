<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <title>Zoho Desk - Apps</title>
</head>

<body>
<h2>This is a samplesdsdd App built using ZET CLI.</h2>

<script src="https://js.zohostatic.com/support/developer_sdk/v1/js/ZohoDeskClientSDK.min.js"></script>
<script>
    const orgID = "847734955";

    function processChangeTicketStatus() {
        ZOHODESK.get("ticket").then(function (response) {
            if (!response || response.status !== "success" || !response.ticket) {
                return;
            }

            let ticket = response.ticket;
            if (ticket.status !== "Open") {
                return;
            }

            ZOHODESK.get("user").then(function (userResponse) {
                const userID = userResponse.user.id;

                if (ticket.assignee.id === userID) {
                    const requestParams = {
                        url: "https://desk.zoho.com/api/v1/tickets",
                        type: "GET",
                        headers: {
                            "Content-Type": "application/json",
                            orgId: orgID,
                        },
                        postBody: {},
                        data: {
                            assignee: userID,
                            status: "In Progress",
                            departmentId: ticket.departmentId,
                            limit: 1
                        },
                        connectionLinkName: "sm_zoho_desk_conn",
                    };

                    ZOHODESK.request(requestParams).then(function (res) {
                        let jsonResponse = JSON.parse(res).response;
                        let responseData = JSON.parse(jsonResponse).statusMessage.data;

                        if (responseData && responseData.length) {
                            let currentInProgressTicket = responseData.shift();
                            alertMessage({
                                title: `Status Notification: Ticket #${ticket.number}`,
                                content: `Current ticket status cannot be changed. Ticket #${currentInProgressTicket.ticketNumber} is currently In Progress`,
                                icon: "failure",
                            });
                        } else {
                            let requestParams = {
                                url: `https://support.zoho.com/api/v1/tickets/${ticket.id}/blueprint`,
                                type: "GET",
                                headers: {
                                    "Content-Type": "application/json",
                                    orgId: orgID,
                                },
                                postBody: {},
                                data: {},
                                connectionLinkName: "sm_zoho_desk_conn",
                            };

                            ZOHODESK.request(requestParams).then(function (resp) {
                                let varResp = JSON.parse(resp).response;
                                let blueprintID = JSON.parse(varResp).statusMessage.id;
                                if (blueprintID) {
                                    updateStatusViaBlueprintTransition(blueprintID, ticket);
                                } else {
                                    updateStatusViaAPI(ticket);
                                }
                            }).catch(function (transitionErr) {
                                console.log(transitionErr);
                                alertMessage({
                                    title: `Error!`,
                                    content: `Please Contact the Administration`,
                                    icon: "failure",
                                });
                            });
                        }
                    }).catch(function (err) {
                        console.log(err);
                        alertMessage({
                            title: `Error!`,
                            content: `Please Contact the Administration`,
                            icon: "failure",
                        });
                    });
                }
            }).catch(function (error) {
                console.log(error);
                alertMessage({
                    title: `Error!`,
                    content: `Please Contact the Administration`,
                    icon: "failure",
                });
            });
        }).catch(function (err) {
            console.log(err);
        })
    }
    
    function updateStatusViaBlueprintTransition(blueprintID, ticket) {
        let requestParams = {
            url: `https://support.zoho.com/api/v1/blueprints/${blueprintID}`,
            type: "GET",
            headers: {
                "Content-Type": "application/json",
                orgId: orgID,
            },
            postBody: {},
            data: {},
            connectionLinkName: "sm_zoho_desk_conn",
        };

        ZOHODESK.request(requestParams).then(function (blueprintRes) {
            blueprintRes = JSON.parse(blueprintRes).response;
            let blueprintTransitions = JSON.parse(blueprintRes).statusMessage.transitions;

            let transitionID;
            Object.values(blueprintTransitions).forEach(function (data) {
                if (data.name === "In Progress") {
                    transitionID = data.id;
                    return;
                }
            });

            let transitionParams = {
                url: `https://support.zoho.com/api/v1/tickets/${ticket.id}/transitions/${transitionID}/perform`,
                type: "POST",
                headers: {
                    "Content-Type": "application/json",
                    orgId: orgID,
                },
                postBody: {"FIELD_UPDATE": {"channel": ""}},
                data: {},
                connectionLinkName: "sm_zoho_desk_conn",
            };

            ZOHODESK.request(transitionParams).then(function (transitionRes) {
                alertMessage({
                    title: `Status Notification: Ticket #${ticket.number}`,
                    content: "Status was changed to In Progress.",
                    icon: "success",
                });
            }).catch(function (transitionErr) {
                console.log(transitionErr);
                alertMessage({
                    title: `Error!`,
                    content: `Please Contact the Administration`,
                    icon: "failure",
                });
            });
        }).catch(function (blueprintErr) {
            console.log(JSON.parse(blueprintErr));
            alertMessage({
                title: `Error!`,
                content: `Please Contact the Administration`,
                icon: "failure",
            });
        });
    }

    function updateStatusViaAPI(ticket) {
        let params = {
            url: `https://support.zoho.com/api/v1/tickets/${ticket.id}`,
            type: "PATCH",
            headers: {
                "Content-Type": "application/json",
                orgId: orgID,
            },
            postBody: {
                "status" : "In Progress"
            },
            data: {},
            connectionLinkName: "sm_zoho_desk_conn",
        };

        ZOHODESK.request(params).then(function (resp) {
            alertMessage({
                title: `Status Notification: Ticket #${ticket.number}`,
                content: "Status was changed to In Progress.",
                icon: "success",
            });
        }).catch(function (err) {
            console.log(err);
            alertMessage({
                title: `Error!`,
                content: `Please Contact the Administration`,
                icon: "failure",
            });
        });
    }

    function alertMessage(data) {
        const alertParams = {
            title: data.title,
            content: data.content,
            icon: data.icon,
            autoClose: true,
        };

        ZOHODESK.notify(alertParams);
    }

    window.onload = () => {
        ZOHODESK.extension.onload().then(function (App) {
            processChangeTicketStatus();

            App.instance.on("ticket_Shift", function (data) {
                if (!data) {
                    console.log("Something Went Wrong in Ticket Shift Function");
                    return;
                }

                processChangeTicketStatus();
            })
        });
    };
</script>

<script src="./js/extension.js" charset="utf-8"></script>
</body>
</html>
